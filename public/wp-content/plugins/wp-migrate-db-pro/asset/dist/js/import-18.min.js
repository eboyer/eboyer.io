!function(a,b){function c(a,b){return"import"===b.intent&&(a="completed"===b.stage?wpmdb_strings.import_label_completed:wpmdb_strings.import_label_migrating),a}function d(b){var c=a(".import-file-status");"import"===b.migration_type?(n?r&&a(".unrecognized-import-file-notice").show():(a(".step-two").hide(),c.hasClass("profile-loaded")?(c.attr("class","import-file-status profile-loaded notification-message success-notice"),c.html(wpmdb_strings.import_profile_loaded)):c.html(wpmdb_strings.please_select_sql_file),c.show()),k(),a(".mst-options").hide(),a(".import-find-replace-option, .import-active-plugin-option").show()):(a('.find-replace-rows, .table-options, .advanced-options, .exclude-post-types-options, label[for="backup-selected"]').show(),a(".import-find-replace-option, .find-replace-options, .import-file-status, .import-active-plugin-option, .unrecognized-import-file-notice").hide(),"search_all_imported"===a("input[name=table_migrate_option]:checked").val()&&a("input[name=table_migrate_option][value=migrate_only_with_prefix]").prop("checked",!0))}function e(a){"import"===wpmdb_migration_type()&&("backup"===a&&b.common.hooks.push(b.functions.migrate_table_recursive),b.common.hooks.push(b.functions.upload_file_recursive),b.common.next_step_in_migration={fn:wpmdb_call_next_hook},b.functions.execute_next_step())}function f(){a("#select-tables").remove(),a(".select-tables-wrap").prepend(o),a("#select-tables").change()}function g(a){return"import"===wpmdb_migration_type()&&(a=q),a}function h(c){"import"===wpmdb_migration_type()&&(b.current_migration.model.addStage("upload",[],"local",{strings:{stage_title:wpmdb_strings.upload}}),b.current_migration.model.addStage("import",[],"local",{strings:{stage_title:wpmdb_strings.migrate_button_import}}),a("#import-find-replace").is(":checked")&&(p=c.tables_to_migrate,b.current_migration.model.addStage("find_replace",[],"local",{strings:{migrated:wpmdb_strings.searched,stage_title:wpmdb_strings.migrate_button_find_replace}})))}function i(a){return"import"===wpmdb_migration_type()&&(a.import_info=t),a}function j(c){var d=c.target.files,e=d[0],f=new FileReader,g=a(".import-file-status"),h=a('label[for="backup-selected"]'),i=a(".prefix-notice"),j=a(".unrecognized-import-file-notice"),l=a(".step-two");if(g.hide().attr("class","import-file-status"),i.hide(),j.hide(),l.hide(),!d.length)return void(n&&(l.hide(),g.text(wpmdb_strings.please_select_sql_file).show(),n=!1));if(".sql"!==e.name.slice(-4)&&".sql.gz"!==e.name.slice(-7))return g.addClass("notification-message error-notice migration-error").text(wpmdb_strings.invalid_sql_file).show(),void l.hide();n=!0,s="",g.text(wpmdb_strings.parsing_sql_file).append(u).show(),f.onloadend=function(c){c.target.readyState===FileReader.DONE&&a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:"wpmdb_get_import_info",file_data:c.target.result,nonce:wpmdb_data.nonces.import_file},error:function(a,b,c){console.log(a,b,c)},success:function(c){if(a(".ajax-spinner").remove(),g.hide(),l.show(),"undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error)g.text(c.body).addClass("notification-message error-notice migration-error").show(),l.hide();else{var d=b.functions.get_localStorage_form_data();if(t=c,"undefined"!=typeof c.prefix&&(s=c.prefix,a(".table-prefix").text(c.prefix),b.functions.maybe_show_prefix_notice(c.prefix)),"undefined"!=typeof c.tables){q=c.tables,h.show(),d||(a("#old-url").val(b.functions.remove_protocol(c.URL)),a("#old-path").val(c.path),a("#new-url").val(b.functions.remove_protocol(wpmdb_data.this_url)),a("#new-path").val(wpmdb_data.this_path));var e=[],f=[];if(d?(e=d.select_tables,f=d.select_post_types,b.functions.remove_localStorage_form_data()):"migrate_only_with_prefix"!==a("input[name=table_migrate_option]:checked").val()||g.hasClass("profile-loaded")||a("input[name=table_migrate_option][value=search_all_imported]").prop("checked",!0),!1===wpmdb_default_profile&&"undefined"!=typeof wpmdb_loaded_tables&&(e=wpmdb_loaded_tables,f=wpmdb_loaded_post_types),o=b.functions.create_table_select(c.tables,[],e),a.wpmdb.do_action("wpmdb_update_import_table_select"),"undefined"!=typeof c.post_types){var i=document.createElement("select");a(i).attr({multiple:"multiple",name:"select_post_types[]",id:"select-post-types",class:"multiselect"}),a.each(c.post_types,function(b,c){var d=a.inArray(c,f);d=-1!==d||!0===wpmdb_convert_exclude_revisions&&"revision"!==c;var e=document.createElement("option");e.value=c,e.text=c,e.selected=d,i.add(e,null)}),a("#select-post-types").remove(),a(".exclude-post-types-warning").after(i)}r&&(r=!1,k())}else j.show(),h.hide(),a(".table-options").hide(),r=!0}}})};var m=e.slice(0,1024e3);f.readAsDataURL(m)}function k(){var b=a(".find-replace-rows");return a("#import-find-replace").is(":checked")?b.show():b.hide()}function l(){r&&setTimeout(function(){a(".find-replace-options-toggle .expand-collapse-arrow").hasClass("collapsed")||a(".table-options").hide()},1)}function m(){a("input[name=keep_active_plugins]").prop("checked",a(this).is(":checked"))}var n=!1,o=a("#select-tables").clone(),p=[],q=[],r=!1,s="",t={},u='<img src="'+b.functions.get_spinner_url()+'" alt="" class="ajax-spinner general-spinner" />';a.wpmdb.add_filter("wpmdb_get_migration_status_label",c),a.wpmdb.add_action("move_connection_info_box",d),a.wpmdb.add_action("wpmdb_migration_initiated",e),a.wpmdb.add_action("wpmdb_update_import_table_select",f),a.wpmdb.add_filter("wpmdb_backup_selected_tables",g),a.wpmdb.add_action("wpmdb_add_migration_stages",h),a.wpmdb.add_filter("wpmdb_initiate_migration_request_data",i),a("#import-file").on("change",j),a("#import-find-replace").on("click",k),a(".find-replace-options-toggle").on("click",l),a("input[name=keep_active_plugins]").on("click",m),b.functions.upload_file_recursive=function(c){c="undefined"==typeof c?0:c;var d=document.getElementById("import-file").files[0],e=1024e3,f=c+e+1,g=new FileReader;0===c&&b.current_migration.model.addStageItem("upload",d.name,d.size/1e3,Math.ceil(d.size/e)),g.onloadend=function(g){g.target.readyState===FileReader.DONE&&a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:"wpmdb_upload_file",file_data:g.target.result,file:d.name,file_type:d.type,migration_state_id:b.migration_state_id,stage:"import",import_info:t,nonce:wpmdb_data.nonces.import_file},error:function(a,c,d){console.log(a,c,d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(a){if(b.current_migration.setText(),"undefined"!=typeof a.wpmdb_error&&1===a.wpmdb_error)return b.common.migration_error=!0,b.functions.migration_complete_events(),void b.current_migration.setState(wpmdb_strings.migration_failed,a.body,"error");var g=c+e;b.current_migration.setText(wpmdb_strings.uploading_file_to_server),b.current_migration.model.getStageModel("upload").setItemRowsTransferred(d.name,Math.ceil(g/e)),f<d.size?b.common.next_step_in_migration={fn:b.functions.upload_file_recursive,args:[f]}:b.common.next_step_in_migration={fn:b.functions.upload_import_successful,args:[d]},b.functions.execute_next_step()}})};var h=d.slice(c,f);g.readAsDataURL(h)},b.functions.upload_import_successful=function(c){a.ajax({type:"POST",url:ajaxurl,data:{action:"wpmdb_prepare_import_file",migration_state_id:b.migration_state_id,nonce:wpmdb_data.nonces.import_file},dataType:"json",error:function(a,c,d){console.log(a,c,d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(a){var d=c.name,e=wpmdb_strings.importing_file_to_db;".gz"===d.slice(-3)&&(d=c.name.slice(0,-3)),e=e.replace(/\%s\s?/,d),b.current_migration.setText(e),b.current_migration.model.addStageItem("import",d,a.import_size/1e3,a.num_chunks),b.current_migration.model.setActiveStage("import"),b.common.next_step_in_migration={fn:b.functions.import_file_recursive,args:[{import_filename:a.import_file,item_name:d,chunk:0,current_query:""}]},b.functions.execute_next_step()}})},b.functions.import_file_recursive=function(c){a.ajax({type:"POST",url:ajaxurl,data:{action:"wpmdb_import_file",migration_state_id:b.migration_state_id,chunk:c.chunk,current_query:c.current_query,import_file:c.import_filename,nonce:wpmdb_data.nonces.import_file},dataType:"json",error:function(a,c,d){console.log(a,c,d),b.common.migration_error=!0,b.functions.migration_complete_events()},success:function(d){if("undefined"!=typeof d.wpmdb_error&&1===d.wpmdb_error)return b.common.migration_error=!0,b.functions.migration_complete_events(),void b.current_migration.setState(wpmdb_strings.migration_failed,d.body,"error");if(b.current_migration.model.getStageModel("import").setItemRowsTransferred(c.item_name,d.chunk),d.chunk>=d.num_chunks){if(b.current_migration.model.getStageModel("import").setItemRowsTransferred(c.item_name,++d.chunk),a("#import-find-replace").is(":checked")){if(r)a.each(d.table_sizes,function(a,c){if(a.startsWith(wpmdb_data.this_temp_prefix)&&wpmdb_data.alter_table_name!==a){var e=a.replace(wpmdb_data.this_temp_prefix,"");b.current_migration.model.addStageItem("find_replace",e,d.table_sizes[a],d.table_rows[a])}});else{var e=a("input[name=table_migrate_option]:checked").val();"migrate_only_with_prefix"===e?p=q.filter(function(a){return s===a.substring(0,s.length)}):"search_all_imported"===e&&(p=q),a.each(p,function(a,c){var e=wpmdb_data.this_temp_prefix+c;d.table_sizes.hasOwnProperty(e)&&b.current_migration.model.addStageItem("find_replace",c,d.table_sizes[e],d.table_rows[e])})}return p=[],b.current_migration.model.setActiveStage("find_replace"),b.common.next_step_in_migration={fn:b.functions.migrate_table_recursive,args:[0]},void b.functions.execute_next_step()}a(".progress-label").removeClass("label-visible"),b.common.hooks=a.wpmdb.apply_filters("wpmdb_before_migration_complete_hooks",b.common.hooks),b.common.hooks.push(b.functions.migration_complete),b.common.hooks.push(b.functions.wpmdb_flush),b.common.hooks=a.wpmdb.apply_filters("wpmdb_after_migration_complete_hooks",b.common.hooks),b.common.hooks.push(b.functions.migration_complete_events),b.common.next_step_in_migration={fn:wpmdb_call_next_hook}}else b.common.next_step_in_migration={fn:b.functions.import_file_recursive,args:[{import_filename:c.import_filename,item_name:c.item_name,chunk:d.chunk,current_query:d.current_query}]};b.functions.execute_next_step()}})},b.functions.get_tables_to_import=function(){return q}}(jQuery,wpmdb);